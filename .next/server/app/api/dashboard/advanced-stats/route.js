(()=>{var e={};e.id=1185,e.ids=[1185],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4160:(e,t,r)=>{"use strict";r.d(t,{eW:()=>a});var s=r(46101);async function o(){try{let e=process.env.DB_HOST||process.env.MYSQL_HOST||"localhost",t=process.env.DB_USER||process.env.MYSQL_USER||"root",r=process.env.DB_PASSWORD||process.env.MYSQL_PASSWORD||"",o=process.env.DB_NAME||process.env.MYSQL_DATABASE||"unityvoice",a="true"===process.env.DB_SSL||"true"===process.env.MYSQL_SSL;console.log(`Attempting to connect to MySQL database: ${t}@${e}/${o}`);let n=await s.createConnection({host:e,user:t,password:r,database:o,ssl:a?{rejectUnauthorized:!1}:void 0}),[c]=await n.execute("SELECT 1 as test");return console.log("Database connection successful, test query result:",c),n}catch(e){return console.error("Error creating direct database connection:",e),null}}async function a(e,t,r){let s=null;try{if(!(s=await o()))throw Error("Failed to establish database connection");console.log(`Executing ${r} query:`,e),console.log("Query parameters:",t);let[a]=await s.execute(e,t);return console.log(`${r} query result:`,JSON.stringify(a)),{success:!0,result:a}}catch(e){return console.error(`Error executing ${r} query:`,e),{success:!1,error:e}}finally{if(s)try{await s.end(),console.log("Database connection closed successfully")}catch(e){console.error("Error closing database connection:",e)}}}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12909:(e,t,r)=>{"use strict";r.d(t,{bw:()=>a});var s=r(43205),o=r.n(s);function a(e){try{if(!e)return null;let t=process.env.JWT_SECRET||"your-fallback-secret";return o().verify(e,t)}catch(e){return console.error("Token verification failed:",e),null}}r(39466)},19771:e=>{"use strict";e.exports=require("process")},27910:e=>{"use strict";e.exports=require("stream")},28303:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=28303,e.exports=t},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39466:(e,t,r)=>{"use strict";let s=process.env.NEXT_PUBLIC_API_URL;async function o(e){let t=e.headers.get("content-type");if(console.log(`Response status: ${e.status}, Content-Type: ${t}`),t&&t.includes("application/json"))try{let t=await e.json();if(!e.ok){let r={status:e.status,statusText:e.statusText,message:t.message||t.error||"API request failed",responseData:t,url:e.url};throw console.error("API Error (JSON):",r),r}return t}catch(t){if(!e.ok){let r={status:e.status,statusText:e.statusText,message:`Failed to parse JSON response: ${t}`,responseData:null,url:e.url};throw console.error("API Error (JSON Parse Failed):",r),r}throw t}try{let t=await e.text();if(console.log(`Response text (first 200 chars): ${t.substring(0,200)}`),!e.ok){let r={status:e.status,statusText:e.statusText,message:t||"API request failed",responseData:t,url:e.url};throw console.error("API Error (Text):",r),r}return t}catch(r){let t={status:e.status,statusText:e.statusText,message:`Failed to read response: ${r}`,responseData:null,url:e.url};throw console.error("API Error (Text Read Failed):",t),t}}async function a(e,t={}){let r={"Content-Type":"application/json",...t.headers},n=`${s}${e}`;console.log(`Making API call to: ${n}`);try{let e=await fetch(n,{...t,headers:r,credentials:"include"});return await o(e)}catch(t){throw console.error(`API call failed for ${e}:`,{url:n,error:t,errorMessage:t instanceof Error?t.message:"Unknown error",errorStack:t instanceof Error?t.stack:void 0,headers:r}),t&&"object"==typeof t&&(t.endpoint=e,t.fullUrl=n),t}}},41204:e=>{"use strict";e.exports=require("string_decoder")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45388:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>p,serverHooks:()=>T,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>E});var s={};r.r(s),r.d(s,{GET:()=>l});var o=r(96559),a=r(48088),n=r(37719),c=r(32190),i=r(4160),u=r(12909);async function l(e){try{let t=e.headers.get("authorization");if(!t||!t.startsWith("Bearer "))return c.NextResponse.json({message:"לא מורשה"},{status:401});let r=t.split(" ")[1];if(!(0,u.bw)(r))return c.NextResponse.json({message:"טוקן לא תקף"},{status:401});let s=`
      SELECT 
        COUNT(DISTINCT CASE WHEN LastLogin > DATE_SUB(NOW(), INTERVAL 30 DAY) THEN UserId END) as current_active,
        COUNT(DISTINCT CASE WHEN LastLogin BETWEEN DATE_SUB(NOW(), INTERVAL 60 DAY) 
          AND DATE_SUB(NOW(), INTERVAL 30 DAY) THEN UserId END) as previous_active
      FROM users
      WHERE IsActive = 1
    `,o=`
      SELECT 
        (SELECT AVG(TaskScore) FROM tasks WHERE CompletionDate > DATE_SUB(NOW(), INTERVAL 7 DAY)) as current_score,
        (SELECT AVG(TaskScore) FROM tasks WHERE CompletionDate BETWEEN DATE_SUB(NOW(), INTERVAL 14 DAY) 
          AND DATE_SUB(NOW(), INTERVAL 7 DAY)) as previous_score
    `,a=`
      SELECT 
        COUNT(CASE WHEN CreationDate > DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) as current_month,
        COUNT(CASE WHEN CreationDate BETWEEN DATE_SUB(NOW(), INTERVAL 60 DAY) 
          AND DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) as previous_month
      FROM users
      WHERE IsActive = 1
    `,n=`
      SELECT 
        DAYNAME(CompletionDate) as day_name,
        COUNT(*) as activities,
        AVG(TaskScore) as avg_score
      FROM tasks
      WHERE CompletionDate > DATE_SUB(NOW(), INTERVAL 7 DAY)
      GROUP BY DAYNAME(CompletionDate), WEEKDAY(CompletionDate)
      ORDER BY WEEKDAY(CompletionDate)
    `,l=`
      SELECT 
        DATE(CompletionDate) as activity_date,
        COUNT(*) as daily_activities,
        COUNT(DISTINCT UserId) as unique_users
      FROM tasks
      WHERE CompletionDate > DATE_SUB(NOW(), INTERVAL 30 DAY)
      GROUP BY DATE(CompletionDate)
      ORDER BY activity_date
    `,[p,d,E,T,A]=await Promise.all([(0,i.eW)(s,[],"Fetch user activity change"),(0,i.eW)(o,[],"Fetch score change"),(0,i.eW)(a,[],"Fetch user growth"),(0,i.eW)(n,[],"Fetch weekly activity"),(0,i.eW)(l,[],"Fetch trend forecast")]);if(!p.success||!d.success||!E.success||!T.success||!A.success)return console.error("Database query failed"),c.NextResponse.json({message:"שגיאה בשאילתת מסד הנתונים"},{status:500});let v=p.result?.[0],D=v?.previous_active&&v?.current_active?((v.current_active-v.previous_active)/v.previous_active*100).toFixed(1):"0",N=d.result?.[0],_=N?.previous_score&&N?.current_score?((N.current_score-N.previous_score)/N.previous_score*100).toFixed(1):"0",y=E.result?.[0],h=y?.previous_month&&y?.current_month?((y.current_month-y.previous_month)/y.previous_month*100).toFixed(1):"0",S={activityChange:parseFloat(D),scoreChange:parseFloat(_),userGrowth:parseFloat(h),weeklyActivity:(T.result||[]).map(e=>({...e,day_name:"Sunday"===e.day_name?"ראשון":"Monday"===e.day_name?"שני":"Tuesday"===e.day_name?"שלישי":"Wednesday"===e.day_name?"רביעי":"Thursday"===e.day_name?"חמישי":"Friday"===e.day_name?"שישי":"שבת"})),trendForecast:A.result||[]};return c.NextResponse.json(S)}catch(e){return console.error("Error fetching advanced stats:",e),c.NextResponse.json({message:"שגיאה בלתי צפויה"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/dashboard/advanced-stats/route",pathname:"/api/dashboard/advanced-stats",filename:"route",bundlePath:"app/api/dashboard/advanced-stats/route"},resolvedPagePath:"C:\\Users\\orzil\\OneDrive\\שולחן העבודה\\070525\\unity-voice-frontend-1\\src\\app\\api\\dashboard\\advanced-stats\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:d,workUnitAsyncStorage:E,serverHooks:T}=p;function A(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:E})}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66136:e=>{"use strict";e.exports=require("timers")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7719,580,3205,6101],()=>r(45388));module.exports=s})();