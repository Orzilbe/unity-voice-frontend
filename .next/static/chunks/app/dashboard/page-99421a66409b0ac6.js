(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5105],{5615:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>F});var a=s(95155),i=s(12115),l=s(66681),r=s(35695),n=s(83540),o=s(8782),d=s(34e3),c=s(54811),h=s(94517),x=s(3401),m=s(94754),u=s(96025),g=s(16238),p=s(24026),j=s(83394),v=s(93504),y=s(21374),b=s(85339),f=s(53904),w=s(91788),N=s(17580),k=s(79397),S=s(69074),_=s(33109),E=s(6874),R=s.n(E),C=s(13105);let A=e=>{let{title:t,value:s,icon:i,change:l,changeType:r}=e;return(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-gray-700",children:t}),(0,a.jsx)(i,{className:"h-6 w-6 text-blue-500"})]}),(0,a.jsxs)("div",{className:"flex items-baseline",children:[(0,a.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:s}),void 0!==l&&(0,a.jsxs)("p",{className:"ml-2 text-sm font-medium ".concat("positive"===r?"text-green-600":"text-red-600"),children:["positive"===r?"+":"",l,"%"]})]})]})},U=e=>{let{message:t}=e;return(0,a.jsx)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert",children:(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)(b.A,{className:"h-5 w-5 mr-2"}),(0,a.jsx)("span",{children:t})]})})},T=()=>{var e,t;let[s,b]=(0,i.useState)(null),[E,T]=(0,i.useState)(!0),[F,L]=(0,i.useState)(null),[K,I]=(0,i.useState)("all"),[W,D]=(0,i.useState)("30d"),{isAuthenticated:B,isLoading:O,user:P}=(0,l.A)(),H=(0,r.useRouter)();(0,i.useEffect)(()=>{O||B||H.push("/login")},[B,O,P,H]),(0,i.useEffect)(()=>{(async()=>{if(B)try{T(!0),L(null);let e=localStorage.getItem("token"),t={Authorization:"Bearer ".concat(e),"Content-Type":"application/json"},[s,a,i,l,r,n]=await Promise.all([(0,C.v)("/api/dashboard/user-stats",{headers:t}),(0,C.v)("/api/dashboard/users-by-level",{headers:t}),(0,C.v)("/api/dashboard/topic-popularity?topic=".concat(K),{headers:t}),(0,C.v)("/api/dashboard/user-activity?range=".concat(W),{headers:t}),(0,C.v)("/api/dashboard/completion-rates",{headers:t}),(0,C.v)("/api/dashboard/advanced-stats",{headers:t})]);if(!s.ok||!a.ok||!i.ok||!l.ok||!r.ok||!n.ok)throw Error("Failed to fetch dashboard data");let[o,d,c,h,x,m]=await Promise.all([s.json(),a.json(),i.json(),l.json(),r.json(),n.json()]),u={...o,userGrowth:m.userGrowth,activityChange:m.activityChange,scoreChange:m.scoreChange};b({userStats:u,usersByLevel:d,topicPopularity:c,userActivity:h,completionRates:x,weeklyActivity:m.weeklyActivity,trendForecast:m.trendForecast})}catch(e){console.error("Error fetching dashboard data:",e),L("שגיאה בטעינת נתוני הדשבורד. אנא נסה שוב מאוחר יותר.")}finally{T(!1)}})()},[B,K,W]);let G=async e=>{try{let t=localStorage.getItem("token"),s=await (0,C.v)("/api/dashboard/export?format=".concat(e),{headers:{Authorization:"Bearer ".concat(t),"Content-Type":"application/json"}});if(!s.ok)throw Error("Failed to export data");if("csv"===e){let e=await s.blob(),t=window.URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="dashboard-export-".concat(new Date().toISOString().split("T")[0],".csv"),document.body.appendChild(a),a.click(),a.remove(),window.URL.revokeObjectURL(t)}else{let e=await s.json(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=window.URL.createObjectURL(t),i=document.createElement("a");i.href=a,i.download="dashboard-export-".concat(new Date().toISOString().split("T")[0],".json"),document.body.appendChild(i),i.click(),i.remove(),window.URL.revokeObjectURL(a)}}catch(e){console.error("Error exporting data:",e),L("שגיאה בייצוא הנתונים. אנא נסה שוב.")}};if(O||E)return(0,a.jsx)("div",{className:"flex justify-center items-center h-screen",children:(0,a.jsx)(f.A,{className:"h-8 w-8 animate-spin text-blue-500"})});if(F)return(0,a.jsx)("div",{className:"max-w-7xl mx-auto p-8",children:(0,a.jsx)(U,{message:F})});if(!B)return null;let M=["#0088FE","#00C49F","#FFBB28","#FF8042","#8B5CF6"];return(0,a.jsx)("div",{className:"min-h-screen bg-gray-100 p-8",dir:"rtl",children:(0,a.jsxs)("div",{className:"max-w-7xl mx-auto",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"דשבורד ניתוח משתמשים"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mt-2",children:"ניתוח מקיף של פעילות המשתמשים במערכת"})]}),(0,a.jsx)("div",{className:"flex gap-4 items-center",children:(0,a.jsx)(R(),{href:"/topics",className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all duration-300",children:"חזור לעמוד הראשי"})})]}),(0,a.jsx)("div",{className:"bg-white rounded-lg shadow-md p-4 mb-8",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsxs)("select",{value:K,onChange:e=>I(e.target.value),className:"px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:"all",children:"כל הנושאים"}),(0,a.jsx)("option",{value:"Diplomacy and International Relations",children:"Diplomacy and International Relations"}),(0,a.jsx)("option",{value:"Economy and Entrepreneurship",children:"Economy and Entrepreneurship"}),(0,a.jsx)("option",{value:"Environment and Sustainability",children:"Environment and Sustainability"}),(0,a.jsx)("option",{value:"History and Heritage",children:"History and Heritage"}),(0,a.jsx)("option",{value:"Holocaust and Revival",children:"Holocaust and Revival"}),(0,a.jsx)("option",{value:"Innovation and Technology",children:"Innovation and Technology"}),(0,a.jsx)("option",{value:"Iron Swords War",children:"Iron Swords War"}),(0,a.jsx)("option",{value:"Science and Technology",children:"Science and Technology"}),(0,a.jsx)("option",{value:"Society and Multiculturalism",children:"Society and Multiculturalism"})]}),(0,a.jsxs)("select",{value:W,onChange:e=>D(e.target.value),className:"px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,a.jsx)("option",{value:"7d",children:"7 ימים"}),(0,a.jsx)("option",{value:"30d",children:"30 ימים"}),(0,a.jsx)("option",{value:"90d",children:"90 ימים"}),(0,a.jsx)("option",{value:"1y",children:"שנה"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("button",{onClick:()=>G("json"),className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 flex items-center gap-2",children:[(0,a.jsx)(w.A,{className:"h-4 w-4"}),"ייצוא JSON"]}),(0,a.jsxs)("button",{onClick:()=>G("csv"),className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-300 flex items-center gap-2",children:[(0,a.jsx)(w.A,{className:"h-4 w-4"}),"ייצוא CSV"]})]})]})}),(null==s?void 0:s.userStats)&&(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[(0,a.jsx)(A,{title:"סה״כ משתמשים",value:(null==(e=s.userStats.totalUsers)?void 0:e.toLocaleString())||"0",icon:N.A,change:s.userStats.userGrowth,changeType:s.userStats.userGrowth>=0?"positive":"negative"}),(0,a.jsx)(A,{title:"משתמשים פעילים",value:(null==(t=s.userStats.activeUsers)?void 0:t.toLocaleString())||"0",icon:k.A,change:s.userStats.activityChange,changeType:s.userStats.activityChange>=0?"positive":"negative"}),(0,a.jsx)(A,{title:"משתמשים חדשים החודש",value:String(s.userStats.newUsersThisMonth||0),icon:S.A,change:s.userStats.newUserGrowth,changeType:s.userStats.newUserGrowth>=0?"positive":"negative"}),(0,a.jsx)(A,{title:"ציון ממוצע",value:String(s.userStats.averageScore||0),icon:_.A,change:s.userStats.scoreChange,changeType:s.userStats.scoreChange>=0?"positive":"negative"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8",children:[(null==s?void 0:s.usersByLevel)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"הפלגת משתמשים לפי רמה"}),(0,a.jsx)("div",{className:"h-80",children:(0,a.jsx)(n.u,{width:"100%",height:"100%",children:(0,a.jsxs)(o.r,{children:[(0,a.jsx)(d.F,{data:s.usersByLevel,cx:"50%",cy:"50%",labelLine:!1,label:e=>{let{name:t,value:s}=e;return"".concat(t,": ").concat(s,"%")},outerRadius:80,fill:"#8884d8",dataKey:"value",children:s.usersByLevel.map((e,t)=>(0,a.jsx)(c.f,{fill:M[t%M.length]},"cell-".concat(t)))}),(0,a.jsx)(h.m,{})]})})})]}),(null==s?void 0:s.topicPopularity)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"פופולריות נושאים"}),(0,a.jsx)("div",{className:"h-80",children:(0,a.jsx)(n.u,{width:"100%",height:"100%",children:(0,a.jsxs)(x.E,{data:s.topicPopularity,children:[(0,a.jsx)(m.d,{strokeDasharray:"3 3"}),(0,a.jsx)(u.W,{dataKey:"TopicHe"}),(0,a.jsx)(g.h,{}),(0,a.jsx)(h.m,{formatter:(e,t)=>[e,"total_tasks"===t?"משימות":"השלמות"]}),(0,a.jsx)(p.s,{formatter:e=>"total_tasks"===e?"משימות":"השלמות"}),(0,a.jsx)(j.y,{dataKey:"total_tasks",fill:"#8884d8"}),(0,a.jsx)(j.y,{dataKey:"completed_tasks",fill:"#82ca9d"})]})})})]})]}),(null==s?void 0:s.userActivity)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"פעילות משתמשים לאורך זמן"}),(0,a.jsx)("div",{className:"h-96",children:(0,a.jsx)(n.u,{width:"100%",height:"100%",children:(0,a.jsxs)(v.b,{data:s.userActivity,children:[(0,a.jsx)(m.d,{strokeDasharray:"3 3"}),(0,a.jsx)(u.W,{dataKey:"date"}),(0,a.jsx)(g.h,{}),(0,a.jsx)(h.m,{}),(0,a.jsx)(p.s,{formatter:e=>"activities"===e?"פעילויות":"משתמשים פעילים"}),(0,a.jsx)(y.N,{type:"monotone",dataKey:"activities",stroke:"#8884d8",strokeWidth:2}),(0,a.jsx)(y.N,{type:"monotone",dataKey:"active_users",stroke:"#82ca9d",strokeWidth:2})]})})})]}),(null==s?void 0:s.weeklyActivity)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"פעילות שבועית"}),(0,a.jsx)("div",{className:"h-80",children:(0,a.jsx)(n.u,{width:"100%",height:"100%",children:(0,a.jsxs)(x.E,{data:s.weeklyActivity,children:[(0,a.jsx)(m.d,{strokeDasharray:"3 3"}),(0,a.jsx)(u.W,{dataKey:"day_name"}),(0,a.jsx)(g.h,{}),(0,a.jsx)(h.m,{}),(0,a.jsx)(p.s,{formatter:e=>"activities"===e?"פעילויות":"ציון ממוצע"}),(0,a.jsx)(j.y,{dataKey:"activities",fill:"#8884d8"}),(0,a.jsx)(j.y,{dataKey:"avg_score",fill:"#82ca9d"})]})})})]}),(null==s?void 0:s.completionRates)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"שיעור השלמה לפי סוג פעילות"}),(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:s.completionRates.map((e,t)=>(0,a.jsxs)("div",{className:"flex flex-col items-center",children:[(0,a.jsxs)("div",{className:"relative w-24 h-24 mb-2",children:[(0,a.jsxs)("svg",{className:"w-full h-full transform -rotate-90",children:[(0,a.jsx)("circle",{cx:"48",cy:"48",r:"40",stroke:"#E5E7EB",strokeWidth:"8",fill:"none"}),(0,a.jsx)("circle",{cx:"48",cy:"48",r:"40",stroke:M[t%M.length],strokeWidth:"8",fill:"none",strokeDasharray:"".concat(2*Math.PI*40),strokeDashoffset:"".concat(2*Math.PI*40*(1-e.rate/100)),strokeLinecap:"round"})]}),(0,a.jsxs)("span",{className:"absolute inset-0 flex items-center justify-center text-xl font-bold",children:[e.rate,"%"]})]}),(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-700",children:e.name})]},t))})]}),(null==s?void 0:s.topicPopularity)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-8",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"נושאים מובילים לפי ציון ממוצע"}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"נושא"}),(0,a.jsx)("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"משימות"}),(0,a.jsx)("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"השלמות"}),(0,a.jsx)("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"ציון ממוצע"})]})}),(0,a.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:s.topicPopularity.sort((e,t)=>t.avg_score-e.avg_score).map((e,t)=>(0,a.jsxs)("tr",{className:t%2==0?"bg-white":"bg-gray-50",children:[(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:e.TopicHe||e.TopicName}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.total_tasks}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:e.completed_tasks}),(0,a.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:(0,a.jsxs)("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full ".concat(e.avg_score>=80?"bg-green-100 text-green-800":e.avg_score>=70?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"),children:["number"==typeof e.avg_score?e.avg_score.toFixed(1):"0","                          "]})})]},t))})]})})]}),(null==s?void 0:s.trendForecast)&&(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"מגמות פעילות - 30 ימים אחרונים"}),(0,a.jsx)("div",{className:"h-80",children:(0,a.jsx)(n.u,{width:"100%",height:"100%",children:(0,a.jsxs)(v.b,{data:s.trendForecast,children:[(0,a.jsx)(m.d,{strokeDasharray:"3 3"}),(0,a.jsx)(u.W,{dataKey:"activity_date"}),(0,a.jsx)(g.h,{}),(0,a.jsx)(h.m,{}),(0,a.jsx)(p.s,{formatter:e=>"daily_activities"===e?"פעילויות יומיות":"משתמשים ייחודיים"}),(0,a.jsx)(y.N,{type:"monotone",dataKey:"daily_activities",stroke:"#8884d8",strokeWidth:2}),(0,a.jsx)(y.N,{type:"monotone",dataKey:"unique_users",stroke:"#82ca9d",strokeWidth:2})]})})})]})]})})};function F(){let{isAuthenticated:e,isLoading:t,user:s}=(0,l.A)(),n=(0,r.useRouter)();return((0,i.useEffect)(()=>{console.log("Dashboard Page - Auth State:",{isAuthenticated:e,isLoading:t,user:s,role:null==s?void 0:s.role,UserRole:null==s?void 0:s.UserRole}),t||(e?(null==s?void 0:s.role)!=="admin"&&(null==s?void 0:s.UserRole)!=="admin"&&(console.log("Not admin, redirecting to topics"),n.push("/topics")):(console.log("Not authenticated, redirecting to login"),n.push("/login")))},[e,t,s,n]),t)?(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):e&&((null==s?void 0:s.role)==="admin"||(null==s?void 0:s.UserRole)==="admin")?(0,a.jsx)(T,{}):(console.log("Not rendering dashboard - Auth check failed:",{isAuthenticated:e,role:null==s?void 0:s.role,UserRole:null==s?void 0:s.UserRole}),null)}},13105:(e,t,s)=>{"use strict";async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return fetch(e,{credentials:"include",headers:{"Content-Type":"application/json",...t.headers||{}},...t})}s.d(t,{v:()=>a})},23141:(e,t,s)=>{Promise.resolve().then(s.bind(s,5615))}},e=>{var t=t=>e(e.s=t);e.O(0,[6874,6797,6681,8441,1684,7358],()=>t(23141)),_N_E=e.O()}]);